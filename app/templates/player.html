{% extends "base.html" %}

{% block title %}{{ channel.name }} - Reproductor IPTV{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #000;
        color: #fff;
    }

    .player-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .video-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #000;
    }

    .video-js {
        width: 100% !important;
        height: 100% !important;
        max-height: calc(100vh - 120px);
    }

    .controls-overlay {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.7);
        border-radius: 10px;
        padding: 15px;
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    .controls-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .channel-info {
        background: rgba(0, 0, 0, 0.8);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .navbar-dark {
        background-color: rgba(0, 0, 0, 0.9) !important;
    }

    .btn-glass {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
    }

    .btn-glass:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 8px;
    }

    .status-indicator.connecting {
        background-color: #ffc107;
        animation: pulse 1.5s infinite;
    }

    .status-indicator.connected {
        background-color: #28a745;
    }

    .status-indicator.error {
        background-color: #dc3545;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    .fullscreen-btn {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1001;
    }

    @media (max-width: 768px) {
        .controls-overlay {
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 10px;
        }

        .fullscreen-btn {
            bottom: 10px;
            right: 10px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="player-container">
    <!-- Controles superpuestos -->
    <div class="controls-overlay" id="controlsOverlay">
        <div class="row align-items-center">
            <div class="col-auto">
                <button class="btn btn-glass btn-sm" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Volver
                </button>
            </div>

            <div class="col">
                <div class="d-flex align-items-center">
                    <span class="status-indicator connecting" id="statusIndicator"></span>
                    <h5 class="mb-0 me-3">{{ channel.name }}</h5>
                    <span class="badge bg-secondary">{{ channel.group_title or 'Sin categoría' }}</span>
                </div>
            </div>

            <div class="col-auto">
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-glass" onclick="toggleFavorite({{ channel.id }}, this)" id="favoriteBtn">
                        <i class="bi bi-heart"></i>
                    </button>

                    <button class="btn btn-glass" onclick="shareChannel()">
                        <i class="bi bi-share"></i>
                    </button>

                    <button class="btn btn-glass" onclick="toggleControls()">
                        <i class="bi bi-gear"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor del video -->
    <div class="video-container" onclick="toggleControlsVisibility()">
        <video id="mainPlayer" class="video-js vjs-default-skin" controls preload="none"
            data-setup='{"fluid": true, "responsive": true}'>
            <p class="vjs-no-js">
                Para ver este video, habilita JavaScript y considera actualizar a un
                <a href="https://videojs.com/html5-video-support/" target="_blank">
                    navegador que soporte video HTML5
                </a>.
            </p>
        </video>
    </div>

    <!-- Botón de pantalla completa flotante -->
    <button class="btn btn-glass fullscreen-btn" onclick="toggleFullscreen()" id="fullscreenBtn">
        <i class="bi bi-arrows-fullscreen"></i>
    </button>
</div>

<!-- Modal de información del canal -->
<div class="modal fade" id="channelInfoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Información del Canal</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        {% if channel.logo %}
                        <div class="text-center mb-3">
                            <img src="{{ channel.logo }}" class="img-fluid rounded" style="max-height: 100px;"
                                alt="{{ channel.name }}">
                        </div>
                        {% endif %}

                        <table class="table table-dark">
                            <tr>
                                <td><strong>Nombre:</strong></td>
                                <td>{{ channel.name }}</td>
                            </tr>
                            <tr>
                                <td><strong>Categoría:</strong></td>
                                <td>{{ channel.group_title or 'Sin categoría' }}</td>
                            </tr>
                            {% if channel.tvg_id %}
                            <tr>
                                <td><strong>TVG ID:</strong></td>
                                <td>{{ channel.tvg_id }}</td>
                            </tr>
                            {% endif %}
                            {% if channel.tvg_name %}
                            <tr>
                                <td><strong>TVG Name:</strong></td>
                                <td>{{ channel.tvg_name }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td><strong>URL:</strong></td>
                                <td class="text-break"><small>{{ channel.url }}</small></td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de configuración -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Configuración del Reproductor</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-12">
                        <label class="form-label">Calidad de video</label>
                        <select class="form-select bg-dark text-white border-secondary" id="qualitySelect">
                            <option value="auto">Automática</option>
                            <option value="1080p">1080p</option>
                            <option value="720p">720p</option>
                            <option value="480p">480p</option>
                        </select>
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoplayCheck">
                            <label class="form-check-label" for="autoplayCheck">
                                Reproducción automática
                            </label>
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="loopCheck">
                            <label class="form-check-label" for="loopCheck">
                                Reproducir en bucle
                            </label>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Volumen</label>
                        <input type="range" class="form-range" min="0" max="100" value="50" id="volumeSlider">
                        <div class="text-center"><small id="volumeDisplay">50%</small></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="applySettings()">Aplicar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let player = null;
    let controlsVisible = true;
    let hideControlsTimeout = null;

    // Inicializar reproductor cuando la página cargue
    document.addEventListener('DOMContentLoaded', function () {
        initializePlayer();
        setupEventListeners();
        loadPlayerSettings();
        autoHideControls();
    });

    // Inicializar Video.js
    function initializePlayer() {
        const statusIndicator = document.getElementById('statusIndicator');
        const channelId = {{ channel.id }
    };
    // Usar URL del stream HLS con FFmpeg
    const hlsUrl = `/api/stream/${channelId}/playlist.m3u8`;

    player = videojs('mainPlayer', {
        fluid: true,
        responsive: true,
        controls: true,
        preload: 'auto',
        autoplay: true,
        sources: [{
            src: hlsUrl,
            type: 'application/x-mpegURL'
        }],
        html5: {
            vhs: {
                overrideNative: true
            }
        }
    });

    // Eventos del reproductor
    player.ready(function () {
        console.log('Reproductor inicializado');
        statusIndicator.className = 'status-indicator connecting';
    });

    player.on('loadstart', function () {
        statusIndicator.className = 'status-indicator connecting';
    });

    player.on('canplay', function () {
        statusIndicator.className = 'status-indicator connected';
    });

    player.on('error', function (error) {
        console.error('Error en el reproductor:', error);
        statusIndicator.className = 'status-indicator error';
        showNotification('Error al reproducir el canal. Verifica la conexión.', 'error');
    });

    player.on('play', function () {
        console.log('Reproducción iniciada');
    });

    player.on('pause', function () {
        console.log('Reproducción pausada');
    });
    }

    // Configurar event listeners
    function setupEventListeners() {
        // Control de volumen
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.getElementById('volumeDisplay');

        volumeSlider.addEventListener('input', function () {
            const volume = this.value / 100;
            volumeDisplay.textContent = this.value + '%';
            if (player) {
                player.volume(volume);
            }
        });

        // Teclas de acceso rápido
        document.addEventListener('keydown', function (e) {
            if (!player) return;

            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    if (player.paused()) {
                        player.play();
                    } else {
                        player.pause();
                    }
                    break;
                case 'KeyF':
                    e.preventDefault();
                    toggleFullscreen();
                    break;
                case 'KeyM':
                    e.preventDefault();
                    player.muted(!player.muted());
                    break;
                case 'Escape':
                    if (document.fullscreenElement) {
                        document.exitFullscreen();
                    }
                    break;
                case 'KeyI':
                    e.preventDefault();
                    toggleControls();
                    break;
            }
        });

        // Ocultar controles automáticamente
        document.addEventListener('mousemove', autoHideControls);
        document.addEventListener('click', autoHideControls);
    }

    // Auto-ocultar controles
    function autoHideControls() {
        showControls();

        if (hideControlsTimeout) {
            clearTimeout(hideControlsTimeout);
        }

        hideControlsTimeout = setTimeout(() => {
            if (player && !player.paused()) {
                hideControls();
            }
        }, 3000);
    }

    // Mostrar controles
    function showControls() {
        const overlay = document.getElementById('controlsOverlay');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        overlay.classList.remove('hidden');
        fullscreenBtn.style.opacity = '1';
        controlsVisible = true;
    }

    // Ocultar controles
    function hideControls() {
        const overlay = document.getElementById('controlsOverlay');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        overlay.classList.add('hidden');
        fullscreenBtn.style.opacity = '0.3';
        controlsVisible = false;
    }

    // Toggle visibilidad de controles
    function toggleControlsVisibility() {
        if (controlsVisible) {
            hideControls();
        } else {
            showControls();
            autoHideControls();
        }
    }

    // Detectar tipo de stream
    function getStreamType(url) {
        const extension = url.split('.').pop().toLowerCase();
        switch (extension) {
            case 'm3u8':
                return 'application/x-mpegURL';
            case 'mp4':
                return 'video/mp4';
            case 'webm':
                return 'video/webm';
            case 'ogg':
                return 'video/ogg';
            default:
                return 'application/x-mpegURL';
        }
    }

    // Toggle pantalla completa
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            document.getElementById('fullscreenBtn').innerHTML = '<i class="bi bi-fullscreen-exit"></i>';
        } else {
            document.exitFullscreen();
            document.getElementById('fullscreenBtn').innerHTML = '<i class="bi bi-arrows-fullscreen"></i>';
        }
    }

    // Volver atrás
    function goBack() {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            window.close();
        }
    }

    // Toggle favorito
    async function toggleFavorite(channelId, button) {
        try {
            const icon = button.querySelector('i');
            const isFavorite = icon.classList.contains('bi-heart-fill');

            if (isFavorite) {
                await fetch(`/api/favorites/${channelId}`, { method: 'DELETE' });
                icon.className = 'bi bi-heart';
                showNotification('Canal quitado de favoritos', 'info');
            } else {
                await fetch(`/api/favorites/${channelId}`, { method: 'POST' });
                icon.className = 'bi bi-heart-fill';
                showNotification('Canal agregado a favoritos', 'success');
            }
        } catch (error) {
            showNotification('Error al actualizar favoritos', 'error');
        }
    }

    // Compartir canal
    function shareChannel() {
        if (navigator.share) {
            navigator.share({
                title: '{{ channel.name }}',
                text: 'Mira este canal IPTV',
                url: window.location.href
            });
        } else {
            // Fallback: copiar URL al portapapeles
            navigator.clipboard.writeText(window.location.href).then(() => {
                showNotification('URL copiada al portapapeles', 'success');
            });
        }
    }

    // Toggle configuración
    function toggleControls() {
        const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
        modal.show();
    }

    // Aplicar configuración
    function applySettings() {
        const quality = document.getElementById('qualitySelect').value;
        const autoplay = document.getElementById('autoplayCheck').checked;
        const loop = document.getElementById('loopCheck').checked;
        const volume = document.getElementById('volumeSlider').value / 100;

        if (player) {
            player.volume(volume);
            player.loop(loop);
        }

        // Guardar configuración
        localStorage.setItem('playerSettings', JSON.stringify({
            quality,
            autoplay,
            loop,
            volume: volume * 100
        }));

        showNotification('Configuración aplicada', 'success');

        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        modal.hide();
    }

    // Cargar configuración guardada
    function loadPlayerSettings() {
        const settings = localStorage.getItem('playerSettings');
        if (settings) {
            const config = JSON.parse(settings);

            document.getElementById('qualitySelect').value = config.quality || 'auto';
            document.getElementById('autoplayCheck').checked = config.autoplay || false;
            document.getElementById('loopCheck').checked = config.loop || false;
            document.getElementById('volumeSlider').value = config.volume || 50;
            document.getElementById('volumeDisplay').textContent = (config.volume || 50) + '%';
        }
    }

    // Limpiar al salir
    window.addEventListener('beforeunload', function () {
        if (player) {
            player.dispose();
        }
    });
</script>
{% endblock %}